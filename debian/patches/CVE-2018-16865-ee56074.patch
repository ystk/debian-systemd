From ef4d6abe7c7fab6cbff975b32e76b09feee56074 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zbigniew=20J=C4=99drzejewski-Szmek?= <zbyszek@in.waw.pl>
Date: Fri, 7 Dec 2018 10:48:10 +0100
Subject: [PATCH] journal-remote: set a limit on the number of fields in a
 message

Existing use of E2BIG is replaced with ENOBUFS (entry too long), and E2BIG is
reused for the new error condition (too many fields).

This matches the change done for systemd-journald, hence forming the second
part of the fix for CVE-2018-16865
(https://bugzilla.redhat.com/show_bug.cgi?id=1653861).
---
 src/journal-remote/journal-remote-main.c | 7 +++++--
 src/journal-remote/journal-remote.c      | 3 +++
 src/shared/journal-importer.c            | 5 ++++-
 3 files changed, 12 insertions(+), 3 deletions(-)

Index: b/src/journal/journal-remote.c
===================================================================
--- a/src/journal/journal-remote.c	2019-01-22 15:41:54.249815514 -0500
+++ b/src/journal/journal-remote.c	2019-01-22 15:44:51.211806217 -0500
@@ -422,8 +422,10 @@ static int process_http_upload(
 
         while (true) {
                 r = process_source(source, &server->writer, arg_compress, arg_seal);
-                if (r == -E2BIG)
+                if (r == -ENOBUFS)
                         log_warning("Entry too big, skipped");
+                else if (r == -E2BIG)
+                        log_warning("Entry with more fields than the maximum, aborting",
                 else if (r == -EAGAIN || r == -EWOULDBLOCK)
                         break;
                 else if (r < 0) {
@@ -890,6 +892,9 @@ static int dispatch_raw_source_event(sd_
                 remove_source(s, source->fd);
                 log_info("%zd active source remaining", s->active);
         } else if (r == -E2BIG) {
+                log_notice("Entry with too many fields, skipped");
+                r = 1;
+        } else if (r == -ENOBUFS) {
                 log_error("Entry too big, skipped");
                 r = 1;
         }
Index: b/src/journal/journal-remote-write.c
===================================================================
--- a/src/journal/journal-remote-write.c	2019-01-22 15:41:54.249815514 -0500
+++ b/src/journal/journal-remote-write.c	2019-01-22 15:48:12.686336363 -0500
@@ -22,6 +22,9 @@
 #include "journal-remote-write.h"
 
 int iovw_put(struct iovec_wrapper *iovw, void* data, size_t len) {
+        if (iovw->count >= ENTRY_FIELD_COUNT_MAX)
+                return -E2BIG;
+
         if (!GREEDY_REALLOC(iovw->iovec, iovw->size_bytes, iovw->count + 1))
                 return log_oom();
 
