From: Markus Koschany <apo@debian.org>
Date: Wed, 2 Aug 2023 10:06:13 +0200
Subject: CVE-2023-26604

Origin: https://github.com/systemd/systemd/commit/339bf2076b3294e5f7b59e84c59ba8c55ded3c25
---
 man/less-variables.xml | 13 +++++++++++++
 src/shared/pager.c     | 19 +++++++++++++++++++
 2 files changed, 32 insertions(+)

diff --git a/man/less-variables.xml b/man/less-variables.xml
index 09cbd42..40e1f19 100644
--- a/man/less-variables.xml
+++ b/man/less-variables.xml
@@ -25,5 +25,18 @@
                         <command>less</command>
                         (<literal>FRSXMK</literal>).</para></listitem>
                 </varlistentry>
+                <varlistentry id='lesssecure'>
+                        <term><varname>$SYSTEMD_LESSSECURE</varname></term>
+
+                        <listitem><para>Takes a boolean argument. Overrides the
+                        <varname>$LESSSECURE</varname> environment variable
+                        when invoking the pager, which controls the "secure"
+                        mode of less (which disables commands such as
+                        <literal>|</literal> which allow to easily shell out to
+                        external command lines). By default less secure mode is
+                        enabled, with this setting it may be
+                        disabled.</para></listitem>
+                </varlistentry>
+
         </variablelist>
 </refsect1>
diff --git a/src/shared/pager.c b/src/shared/pager.c
index 002e3aa..b00a02b 100644
--- a/src/shared/pager.c
+++ b/src/shared/pager.c
@@ -96,6 +96,25 @@ int pager_open(bool jump_to_end) {
                         less_opts = strappenda(less_opts, " +G");
                 setenv("LESS", less_opts, 1);
 
+                /* People might invoke us from sudo, don't needlessly allow less to be a way to shell out
+                 * privileged stuff. */
+                r = getenv_bool("SYSTEMD_LESSSECURE");
+                if (r == 0) { /* Remove env var if off */
+                        if (unsetenv("LESSSECURE") < 0) {
+                                log_error_errno(errno, "Failed to uset environment variable LESSSECURE: %m");
+                                _exit(EXIT_FAILURE);
+                        }
+                } else {
+                        /* Set env var otherwise */
+                        if (r < 0)
+                                log_warning_errno(r, "Unable to parse $SYSTEMD_LESSSECURE, ignoring: %m");
+
+                        if (setenv("LESSSECURE", "1", 1) < 0) {
+                                log_error_errno(errno, "Failed to set environment variable LESSSECURE: %m");
+                                _exit(EXIT_FAILURE);
+                        }
+                }
+
                 /* Make sure the pager goes away when the parent dies */
                 if (prctl(PR_SET_PDEATHSIG, SIGTERM) < 0)
                         _exit(EXIT_FAILURE);
